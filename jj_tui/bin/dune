(executable
 (public_name jj_tui)
 (name main)
 (modes byte native )
 (libraries
  signal
  jj_tui
  ; nottui
  nottui_picos
  base
  stdio
  picos_io
  picos_mux.multififo
  picos_std.sync
  picos_std.finally
  picos_std.structured
  spawn
  yojson)
 (preprocess
  (pps logs-ppx ppx_deriving.std)))

(env
 (static
  (flags
   (:standard -cclib -static -cclib -no-pie))))

;; Generate a small OCaml module `version.ml` at build time containing:
;;   let version = "<git-describe-or-fallback>"
;; The command prefers an explicitly-provided GIT_DESCRIBE environment variable
;; (useful in CI), otherwise falls back to `git describe`. If neither is
;; available, it writes "unknown". This uses only shell builtins and common
;; utilities (no python required).
(rule
 (targets version.ml)
 (action
  (with-stdout-to version.ml
   (run sh -c
   "v=${GIT_DESCRIBE:-$(git describe --tags --always --dirty 2>/dev/null || echo unknown)};
   esc=$(printf '%s' \"$v\" | sed 's/\\\\/\\\\\\\\/g; s/\"/\\\\\\\"/g');
   printf 'let version = \"%s\"\\n' \"$esc\""
   ))))
